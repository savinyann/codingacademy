!function(t){t.fn.game_2048=function(){function e(e){if(void 0!=e){t("main div div").addClass("baby");for(i=0;i<=15;i++)t("#"+i.toString()).text(e[i]);for(var i=0;i<=15;i++)p(Number(t("#"+i.toString()).text())),setTimeout(function(){t("main div div").removeClass("baby")},50);setTimeout(d,0)}}function o(){if(t("#game_over").hide(),cookie=x("2048_state="),E=0,A=0,null==cookie)t("main div div").text(""),t("main div div").css("background-image","none"),r(),r();else{var i=cookie.split(",");e(i),E=Number(i[16])}a(),t("#bigger_tile").css("background-image","url(media/pict/tile/"+(2*A).toString()+".png)")}function n(t){I=!1,j=!1;var e=t.which||t.keyCode;37==e&&u(),38==e&&c(),39==e&&g(),40==e&&m()}function r(){var e=Math.floor(16*Math.random()),i=Math.random()<.9?"2":"4";""==t("#"+e).text()?(a(),t("#bigger_tile").css("background-image","url(media/pict/tile/"+(2*A).toString()+".png)"),t("#"+e).text(i),C?(t("#"+e).addClass("baby"),setTimeout(function(){t("#"+e).removeClass("baby"),t("#"+e).css("background-image","url(media/pict/tile/"+t("#"+e).text()+".png)")},50)):t("#"+e).css("background-image","url(media/pict/tile/"+t("#"+e).text()+".png)"),S(864e5),setTimeout(h,T)):r()}function a(){t("#score").text(E.toString()),t("#score").css("left","calc(50%-"+t("#score").width()+"px")}function u(){for(var e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i=v(),o=0;o<=3;o++)for(var n=4*o+1;n<=4*o+3;n++){for(var r=n,a=n,u=t("#"+n.toString()).text(),g=t("#"+n.toString()).text();""!=t("#"+n.toString()).text()&&""==t("#"+(n-1).toString()).text()&&n%4!=0;)t("#"+(n-1).toString()).text(t("#"+n.toString()).text()),t("#"+n.toString()).text(""),a=n+=-1,g=t("#"+n.toString()).text();t("#"+n.toString()).text()==t("#"+(n-1).toString()).text()&&""!=t("#"+n.toString()).text()&&0==e[n-1]&&n%4!=0&&(E+=2*Number(t("#"+n.toString()).text()),t("#"+(n-1).toString()).text(2*Number(t("#"+n.toString()).text())),t("#"+n.toString()).text(""),e[n-1]=1,a=n-1,g=t("#"+(n-1).toString()).text()),l(r,a,u,g)}return v(i),!0}function g(){for(var e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i=v(),o=3;o>=0;o--)for(var n=4*o+2;n>=4*o;n+=-1){for(var r=n,a=n,u=t("#"+n.toString()).text(),g=t("#"+n.toString()).text();""!=t("#"+n.toString()).text()&&""==t("#"+(n+1).toString()).text()&&n%4!=3;)t("#"+(n+1).toString()).text(t("#"+n.toString()).text()),t("#"+n.toString()).text(""),a=n+=1,g=t("#"+n.toString()).text();t("#"+n.toString()).text()==t("#"+(n+1).toString()).text()&&""!=t("#"+n.toString()).text()&&0==e[n+1]&&n%4!=3&&(E+=2*Number(t("#"+n.toString()).text()),t("#"+(n+1).toString()).text(2*Number(t("#"+n.toString()).text())),t("#"+n.toString()).text(""),e[n+1]=1,a=n+1,g=t("#"+(n+1).toString()).text()),l(r,a,u,g)}return v(i),!0}function c(){for(var e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i=v(),o=0;o<=3;o++)for(var n=o+4;n<=o+12;n+=4){for(var r=n,a=n,u=t("#"+n.toString()).text(),g=t("#"+n.toString()).text();""!=t("#"+n.toString()).text()&&""==t("#"+(n-4).toString()).text()&&n>3;)t("#"+(n-4).toString()).text(t("#"+n.toString()).text()),t("#"+n.toString()).text(""),a=n+=-4,g=t("#"+n.toString()).text();t("#"+n.toString()).text()==t("#"+(n-4).toString()).text()&&""!=t("#"+n.toString()).text()&&0==e[n-4]&&(E+=2*Number(t("#"+n.toString()).text()),t("#"+(n-4).toString()).text(2*Number(t("#"+n.toString()).text())),t("#"+n.toString()).text(""),e[n-4]=1,a=n-4,g=t("#"+(n-4).toString()).text()),l(r,a,u,g)}return v(i),!0}function m(){for(var e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i=v(),o=3;o>=0;o--)for(var n=o+8;n>=o;n-=4){for(var r=n,a=n,u=t("#"+n.toString()).text(),g=t("#"+n.toString()).text();""!=t("#"+n.toString()).text()&&""==t("#"+(n+4).toString()).text()&&n<12;)t("#"+(n+4).toString()).text(t("#"+n.toString()).text()),t("#"+n.toString()).text(""),a=n+=4,g=t("#"+n.toString()).text();t("#"+n.toString()).text()==t("#"+(n+4).toString()).text()&&""!=t("#"+n.toString()).text()&&0==e[n+4]&&(E+=2*Number(t("#"+n.toString()).text()),t("#"+(n+4).toString()).text(2*Number(t("#"+n.toString()).text())),t("#"+n.toString()).text(""),e[n+4]=1,a=n+4,g=t("#"+(n+4).toString()).text()),l(r,a,u,g)}return v(i),!0}function l(e,i,o,n){if(e!=i){var r=e%4,a=(e-r)/4,u=i%4,g=(i-u)/4;if(a*=150,r*=150,u*=150,g*=150,f(e),C){if(0==I&&T>=2e3){var c=new Audio("media/sound/hit"+Math.floor(8*Math.random()+1).toString()+".mp3");c.volume=y,c.play(),I=!0}t("#field").append("<div class='echo' style='left:"+r.toString()+"px;top:"+a.toString()+"px'></div>"),t("#field .echo:last-child").css("background-image","url(media/pict/tile/"+o.toString()+".png)"),t("#field .echo:last-child").animate({top:g.toString()+"px",left:u.toString()+"px"},{duration:T,queue:!1})}}o!=n&&O.push(i,n)}function s(){if(C)for(var e=0;e<=O.length-1;e+=2){if(0==j&&T>=2e3){var i=new Audio("media/sound/merge"+Math.floor(7*Math.random()+1).toString()+".mp3");i.volume=y,i.play(),j=!0}var o=O[e]%4,n=(O[e]-o)/4;o*=150,n*=150,t("#field").append("<div class='echo' style='display:none;left:"+o.toString()+"px;top:"+n.toString()+"px'></div>"),t("#field .echo:last-child").css("background-image","url(media/pict/tile/"+O[e+1].toString()+".png)"),t("#field .echo:last-child").fadeIn(T),p(O[e+1])}}function f(e){t("#"+e.toString()).css("background-image","none")}function d(){for(var e=0;e<=15;e++)""!=t("#"+e.toString()).text()&&t("#"+e.toString()).css("background-image","url(media/pict/tile/"+t("#"+e.toString()).text()+".png)")}function v(e){if(void 0==e)return e=[],t("main div div:not(.echo)").each(function(){e.push(t(this).text())}),D=e,e;for(var i=!1,o=0;o<=15;o++)e[o]!=t("#"+o.toString()).text()&&(i=!0);1==i&&(S(864e5),setTimeout(s,T),setTimeout(d,T),setTimeout(r,T))}function S(t){var e=new Date;e.setTime(e.getTime()+t);var i=v();i.push(E),document.cookie="2048_state="+i.toString()+";expires="+e.toUTCString()}function x(t){for(all_Cookie=document.cookie,all_Cookie=all_Cookie.split(";"),i=0;i<all_Cookie.length;i++)if(-1!=all_Cookie[i].search(t))return all_Cookie[i].substr(t.length);return null}function p(t){void 0!=t&&Number(t)>A&&(A=Number(t))}function h(){for(var e=0;e<=15;e++){if(""==t("#"+e.toString()).text())return!0;if(t("#"+e.toString()).text()==t("#"+(e-1).toString()).text()&&0!=e&&4!=e&&8!=e&&12!=e)return!0;if(t("#"+e.toString()).text()==t("#"+(e+1).toString()).text()&&3!=e&&7!=e&&11!=e&&15!=e)return!0;if(t("#"+e.toString()).text()==t("#"+(e-4).toString()).text())return!0;if(t("#"+e.toString()).text()==t("#"+(e+4).toString()).text())return!0}S(0),b()}function b(){if(t("#game_over").fadeIn(T),N.volume=0,A>=2048)t("#result").attr("src","media/pict/gameover/victory.png"),(e=new Audio("media/sound/win"+Math.floor(3*Math.random()+1).toString()+".mp3")).play(),e.onended=function(){N.volume=w?Number(t("#music_volume").val())/100:0};else{t("#result").attr("src","media/pict/gameover/defeat.png");var e=new Audio("media/sound/lose"+Math.floor(3*Math.random()+1).toString()+".mp3");e.play(),e.onended=function(){N.volume=w?Number(t("#music_volume").val())/100:0}}}function _(){t.post("php/database_2048.php","import",function(e){var i=JSON.parse(e);t("tr:not(tr:first-child)").remove(),i.forEach(function(e){t("table").append("<tr><td>"+e.Name+"</td><td>"+e.Score+"</td><td>"+e.TileMaxValue+"</td></tr>")})})}function k(){var e=t("#player_name").val();data={export:[e,E,A]},t.post("php/database_2048.php",data)}var N=new Audio("media/music/1.mp3");N.loop=!0,N.volume=Number(t("#music_volume").val())/100,N.play(),t("#animation_speed_number").text((25*Math.floor(t("#animation_speed").val()/25)).toString()+" ms"),t("#music_volume_number").text((5*Math.floor(t("#music_volume").val()/5)).toString()+" %"),t("#effect_volume_number").text((5*Math.floor(t("#effect_volume").val()/5)).toString()+" %");var y=Number(t("#effect_volume").val())/100;_(),t.post("php/database_2048.php","music",function(e){JSON.parse(e).forEach(function(e){t("select#bgm").append("<option class='settings' value="+e.id+">"+e.music_name+"</option>")})}),t.post("php/database_2048.php","class",function(e){JSON.parse(e).forEach(function(e){t("select#main_bg").append("<option class='settings' value="+e.id+">"+e.picture+"</option>")})});var M=!0,w=!0,M=!0,C=!0,T=Number(t("#animation_speed").val()),A=0,D=null,E=0,J=Date.now(),O=[],I=!1,j=!1;o(),t("#bgm").change(function(){N.pause(),(N=new Audio("media/music/"+t(this).val()+".mp3")).volume=w?Number(t("#music_volume").val())/100:0,N.loop=!0,N.play()}),t("#main_bg").change(function(){t("main").css("background-image","url(media/pict/main/"+t(this).val()+".png)")}),t("#music_volume").change(function(){t("#music_volume_number").text((5*Math.floor(t(this).val()/5)).toString()+" %"),N.volume=w?Number(t(this).val())/100:0}),t("#music_activated").change(function(){w=!w,N.volume=w?Number(t("#music_volume").val())/100:0}),t("#effect_volume").change(function(){t("#effect_volume_number").text((5*Math.floor(t(this).val()/5)).toString()+" %"),y=M?Number(t(this).val())/100:0}),t("#effect_activated").change(function(){M=!M}),t("#animation_speed").change(function(){t("#animation_speed_number").text((25*Math.floor(t(this).val()/25)).toString()+" ms"),T=C?Number(t(this).val()):0}),t("#animation_activated").change(function(){T=(C=!C)?Number(t("#animation_speed").val()):0}),t("#reset").click(function(){S(0),o()}),t("#export").click(function(){N.volume=w?Number(t("#music_volume").val())/100:0,k(),o(),_()}),t("#settings").click(function(){t(".game").hide(),t(".settings").show()}),t("#back").click(function(){t(".game").show(),t(".settings").hide()}),t("*").on("keyup",function(e){Date.now()>J+50&&(t(".echo").remove(),O=[],n(e),J=Date.now()+T)})}}(jQuery);